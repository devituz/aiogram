<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Konkurs â€” Baraban (Telegram IDlar)</title>
  <style>
    :root{--size:640px}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, Roboto, Arial, sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(180deg,#f3f5fb,#eef2f8);
      padding:24px;
      box-sizing:border-box;
    }

    .container{max-width:1100px;width:100%;display:grid;grid-template-columns:1fr 420px;gap:24px;align-items:start}

    .card{background:white;border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(20,30,60,0.08)}

    .wheel-wrap{display:flex;flex-direction:column;align-items:center;gap:14px}
    .wheel-stage{position:relative;width:var(--size);height:var(--size)}
    canvas#wheel{width:100%;height:100%;border-radius:50%;display:block}

    .center-btn{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      width:110px;height:110px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#fff,#f0f6ff);box-shadow:inset 0 2px 6px rgba(255,255,255,.6),0 6px 18px rgba(10,30,60,.08);cursor:pointer;font-weight:700
    }

    .pointer{position:absolute;left:calc(50% - 14px);top:-6px;width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:28px solid #444;filter:drop-shadow(0 2px 2px rgba(0,0,0,0.15))}

    .controls{display:flex;flex-direction:column;gap:12px}
    textarea{width:100%;min-height:220px;padding:10px;border-radius:8px;border:1px solid #e3e8ef;font-family:monospace;resize:vertical}
    button{padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:white;font-weight:600;cursor:pointer}
    button.secondary{background:#6b7280}
    .small{font-size:13px;color:#334155}

    .winner{margin-top:8px;padding:12px;border-radius:8px;background:linear-gradient(90deg,#eef2ff,#fff);font-weight:700;text-align:center}

    @media (max-width:980px){.container{grid-template-columns:1fr} .wheel-stage{--size:360px} }
  </style>
</head>
<body>
  <div class="container">
    <div class="card wheel-wrap">
      <div class="wheel-stage">
        <div class="pointer" title="Pointer"></div>
        <canvas id="wheel" width="640" height="640"></canvas>
        <div id="spinBtn" class="center-btn">SPIN</div>
      </div>
      <div class="small">Baraban avtomatik tarzda foydalanuvchilarning <code>telegram_id</code>larini yuklaydi.</div>
      <div id="winner" class="winner" style="display:none"></div>
    </div>

    <aside class="card controls">
      <h3 style="margin:0 0 6px 0">Telegram IDlar</h3>
      <textarea id="idList" placeholder="Telegram IDlar avtomatik yuklanadi" spellcheck="false"></textarea>
      <div style="display:flex;gap:8px">
        <button id="loadBtn">Yangilash</button>
        <button id="spinAuto" class="secondary">Avtomatik spin (10x)</button>
        <button id="resetBtn" class="secondary">Tiklash</button>
      </div>
      <p class="small">Spin tugmasini bosib g'olibni tanlang. IDlar serverdan avtomatik olinadi.</p>
    </aside>
  </div>

  <script>
    // Backenddan kelgan foydalanuvchilar (Flask/Django kontekstida)
    const telegramIds = [
      {% for user in users %}
        "{{ user.telegram_id }}"{% if not loop.last %},{% endif %}
      {% endfor %}
    ];

    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const spinBtn = document.getElementById('spinBtn');
    const idListEl = document.getElementById('idList');
    const loadBtn = document.getElementById('loadBtn');
    const winnerEl = document.getElementById('winner');
    const spinAuto = document.getElementById('spinAuto');
    const resetBtn = document.getElementById('resetBtn');

    let items = telegramIds || [];
    let colors = [];
    let rotation = 0;
    let spinning = false;

    idListEl.value = items.join('\n');

    function pickColors(n){
      const base = ["#ef4444","#f97316","#f59e0b","#10b981","#06b6d4","#3b82f6","#6366f1","#8b5cf6","#ec4899","#ef4444"];
      const out = [];
      for(let i=0;i<n;i++) out.push(base[i % base.length]);
      return out;
    }

    function parseIds(){
      const raw = idListEl.value.split('\n').map(s=>s.trim()).filter(Boolean);
      items = raw;
      colors = pickColors(items.length);
      if(items.length===0) drawEmpty(); else drawWheel();
    }

    function drawEmpty(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#f3f7fb';
      ctx.beginPath(); ctx.arc(320,320,300,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = '#6b7280'; ctx.font='18px Arial'; ctx.textAlign='center'; ctx.fillText('Hech qanday ID topilmadi',320,320);
    }

    function drawWheel(){
      const cx = canvas.width/2, cy = canvas.height/2, r = 300;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const slice = (Math.PI*2)/items.length;
      for(let i=0;i<items.length;i++){
        const start = rotation + i*slice;
        const end = start + slice;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,start,end);
        ctx.closePath();
        ctx.fillStyle = colors[i];
        ctx.fill();
        ctx.strokeStyle = 'rgba(255,255,255,0.15)'; ctx.lineWidth=2; ctx.stroke();
        ctx.save();
        ctx.translate(cx,cy);
        const angle = start + slice/2;
        ctx.rotate(angle);
        ctx.textAlign = 'right';
        ctx.fillStyle = 'white';
        ctx.font = '18px Arial';
        ctx.fillText(items[i], r-18, 6);
        ctx.restore();
      }
      ctx.beginPath(); ctx.arc(cx,cy,r+6,0,Math.PI*2); ctx.lineWidth=10; ctx.strokeStyle='rgba(0,0,0,0.06)'; ctx.stroke();
      ctx.beginPath(); ctx.arc(cx,cy,72,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
      ctx.beginPath(); ctx.arc(cx,cy,66,0,Math.PI*2); ctx.fillStyle='#e6f0ff'; ctx.fill();
    }

    function easeOutCubic(t){ return (--t)*t*t+1 }

    async function spinToIndex(targetIndex){
      if(spinning || items.length===0) return;
      spinning = true; winnerEl.style.display='none';
      const slice = (Math.PI*2)/items.length;
      const current = (rotation % (Math.PI*2) + Math.PI*2) % (Math.PI*2);
      const pointerAngle = -Math.PI/2;
      const targetSliceMid = targetIndex*slice + slice/2;
      let desiredRotation = pointerAngle - targetSliceMid;
      const extraSpins = Math.floor(Math.random()*3)+4;
      desiredRotation -= extraSpins * Math.PI*2;
      const duration = 4000 + Math.floor(Math.random()*2000);
      const start = performance.now();
      const startRot = rotation;
      return new Promise(resolve=>{
        function frame(now){
          const t = Math.min(1,(now-start)/duration);
          const eased = easeOutCubic(t);
          rotation = startRot + (desiredRotation - startRot)*eased;
          drawWheel();
          if(t<1) requestAnimationFrame(frame); else { spinning=false; determineWinner(); resolve(); }
        }
        requestAnimationFrame(frame);
      })
    }

    function spinRandom(){
      if(items.length===0) return;
      const idx = Math.floor(Math.random()*items.length);
      return spinToIndex(idx);
    }

    function determineWinner(){
      const slice = (Math.PI*2)/items.length;
      const raw = (-Math.PI/2 - rotation - slice/2)/slice;
      let index = Math.round(raw) % items.length;
      index = (index + items.length) % items.length;
      const winner = items[index];
      winnerEl.style.display='block';
      winnerEl.textContent = 'G\'OLIB: ' + winner;
      winnerEl.animate([{transform:'scale(1)'},{transform:'scale(1.06)'},{transform:'scale(1)'}],{duration:800,iterations:1});
    }

    spinBtn.addEventListener('click',()=>{ if(!spinning) spinRandom(); });
    loadBtn.addEventListener('click',()=>{ parseIds(); });
    spinAuto.addEventListener('click',async()=>{
      for(let i=0;i<10;i++){
        await spinRandom();
        await new Promise(r=>setTimeout(r,600));
      }
    });
    resetBtn.addEventListener('click',()=>{ idListEl.value=''; parseIds(); winnerEl.style.display='none'; rotation=0; });

    parseIds();
    canvas.addEventListener('click',()=>{ if(!spinning) spinRandom(); });
    spinBtn.tabIndex=0; spinBtn.addEventListener('keydown',(e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); spinRandom(); } });
  </script>
</body>
</html>
