<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Konkurs Baraban — Telegram IDlar</title>
  <style>
    :root { --size: 640px; }
    * { box-sizing: border-box; }
    html, body {
      height: 100%; margin: 0; padding: 0;
      background: linear-gradient(180deg, #f3f5fb, #eef2f8);
      font-family: 'Inter', 'Roboto', Arial, sans-serif;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
    }
    .wheel-wrap {
      display: flex; flex-direction: column; align-items: center; gap: 18px;
      background: white; padding: 24px; border-radius: 16px;
      box-shadow: 0 6px 20px rgba(20,30,60,0.1);
    }
    .wheel-stage { position: relative; width: var(--size); height: var(--size); }
    canvas#wheel { width: 100%; height: 100%; border-radius: 50%; display: block; }

    .center-btn {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      width: 120px; height: 120px; border-radius: 50%;
      background: linear-gradient(180deg, #fff, #f0f6ff);
      box-shadow: inset 0 2px 6px rgba(255,255,255,.7), 0 6px 18px rgba(10,30,60,.12);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 20px; color: # tab;
      cursor: pointer; user-select: none; transition: transform .15s;
    }
    .center-btn:active { transform: translate(-50%, -50%) scale(0.95); }
    .center-btn.disabled { opacity: 0.6; cursor: not-allowed; pointer-events: none; }

    .pointer {
      position: absolute; left: calc(50% - 14px); top: -8px; width: 0; height: 0;
      border-left: 14px solid transparent; border-right: 14px solid transparent;
      border-bottom: 32px solid #444; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
    }

    @media (max-width: 700px) {
      :root { --size: 360px; }
      .center-btn { width: 90px; height: 90px; font-size: 16px; }
    }

    /* === Modal === */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; backdrop-filter: blur(2px);
      animation: fadeIn .3s ease forwards;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal {
      background: white; padding: 30px 26px; border-radius: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;
      max-width: 320px; width: 100%; animation: popIn .25s ease forwards;
    }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal h2 { margin: 0 0 12px 0; font-size: 22px; color: #111; }
    .modal p { font-size: 18px; font-weight: 600; margin: 0 0 20px 0; color: #1d4ed8; }
    .modal button {
      background: #2563eb; color: white; border: none;
      padding: 10px 20px; border-radius: 8px; font-weight: 600;
      cursor: pointer; font-size: 15px; transition: background .2s;
    }
    .modal button:hover { background: #1d4ed8; }
  </style>
</head>
<body>
  <div class="wheel-wrap">
    <div class="wheel-stage">
      <div class="pointer"></div>
      <canvas id="wheel" width="640" height="640"></canvas>
      <div id="spinBtn" class="center-btn">SPIN</div>
    </div>
  </div>

  <script>
    // Backenddan kelgan foydalanuvchilar (Flask/Django orqali)
    const telegramIds = [
      {% for user in users %}
        "{{ user.telegram_id }}"{% if not loop.last %},{% endif %}
      {% endfor %}
    ];

    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const spinBtn = document.getElementById('spinBtn');

    let items = telegramIds.filter(Boolean).filter(id => id.trim() !== '');
    let rotation = 0;
    let spinning = false;

    // Ranglar
    function pickColors(n) {
      const base = ["#ef4444","#f97316","#f59e0b","#10b981","#06b6d4","#3b82f6","#6366f1","#8b5cf6","#ec4899","#f43f5e"];
      return Array.from({length: n}, (_, i) => base[i % base.length]);
    }
    let colors = pickColors(items.length);

    // Barabanni chizish
    function drawWheel() {
      const cx = canvas.width / 2, cy = canvas.height / 2, r = 300;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (items.length === 0) {
        ctx.fillStyle = "#eee"; ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = "#666"; ctx.font = "18px Arial"; ctx.textAlign = "center";
        ctx.fillText("Hech qanday ID topilmadi", cx, cy);
        return;
      }

      const slice = (Math.PI * 2) / items.length;
      for (let i = 0; i < items.length; i++) {
        const start = rotation + i * slice;
        const end = start + slice;

        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, start, end); ctx.closePath();
        ctx.fillStyle = colors[i]; ctx.fill();
        ctx.strokeStyle = 'rgba(255,255,255,0.15)'; ctx.lineWidth = 2; ctx.stroke();

        ctx.save(); ctx.translate(cx, cy); ctx.rotate(start + slice / 2);
        ctx.textAlign = 'right'; ctx.fillStyle = 'white'; ctx.font = 'bold 18px Arial';
        ctx.fillText(items[i], r - 16, 6); ctx.restore();
      }

      // Markaz doira
      ctx.beginPath(); ctx.arc(cx, cy, 72, 0, Math.PI * 2); ctx.fillStyle = '#fff'; ctx.fill();
    }

    // Easing funksiyasi
    function easeOutCubic(t) { return (--t) * t * t + 1; }

    // Spin funksiyasi
    async function spinRandom() {
      if (spinning || items.length === 0) return;

      spinning = true;
      spinBtn.classList.add('disabled');

      const slice = (Math.PI * 2) / items.length;
      const targetIdx = Math.floor(Math.random() * items.length);
      const pointerAngle = -Math.PI / 2;
      const targetAngle = pointerAngle - (targetIdx * slice + slice / 2);
      const extraSpins = 5 + Math.random() * 3; // 5-8 aylanish
      const totalRotation = targetAngle - extraSpins * (Math.PI * 2);
      const duration = 5000; // 5 soniya
      const start = performance.now();
      const startRot = rotation;

      return new Promise(resolve => {
        function frame(now) {
          const t = Math.min(1, (now - start) / duration);
          const eased = easeOutCubic(t);
          rotation = startRot + (totalRotation - startRot) * eased;
          drawWheel();

          if (t < 1) {
            requestAnimationFrame(frame);
          } else {
            spinning = false;
            spinBtn.classList.remove('disabled');
            const winner = determineWinner();
            showWinnerModal(winner);
            resolve();
          }
        }
        requestAnimationFrame(frame);
      });
    }

    // G'olibni aniqlash
    function determineWinner() {
      const slice = (Math.PI * 2) / items.length;
      const raw = (-Math.PI / 2 - rotation - slice / 2) / slice;
      let index = Math.round(raw) % items.length;
      index = (index + items.length) % items.length;
      return items[index];
    }

    // Modal ko'rsatish
    function showWinnerModal(winner) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <h2>G‘olib aniqlangandi!</h2>
          <p>@${winner}</p>
          <button id="okBtn">OK</button>
        </div>
      `;
      document.body.appendChild(overlay);

      const okBtn = document.getElementById('okBtn');
      okBtn.focus();

      okBtn.addEventListener('click', () => {
        overlay.remove();
        spinning = false; // Muhim: spin qayta ishlasin
      });

      // Enter bosilsa ham yopiladi
      overlay.addEventListener('keydown', e => {
        if (e.key === 'Enter') okBtn.click();
      });
    }

    // Bosish hodisalari
    spinBtn.addEventListener('click', () => {
      if (!spinning && items.length > 0) {
        spinRandom();
      }
    });

    canvas.addEventListener('click', (e) => {
      if (e.target === canvas && !spinning && items.length > 0) {
        spinRandom();
      }
    });

    // Boshlang'ich chizish
    drawWheel();

    // Agar IDlar bo'lmasa, tugmani o'chirish
    if (items.length === 0) {
      spinBtn.classList.add('disabled');
      spinBtn.textContent = "ID YO'Q";
    }
  </script>
</body>
</html>