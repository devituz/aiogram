<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Konkurs Baraban ‚Äî Telegram IDlar</title>
  <style>
    :root { --size:640px }
    html, body {
      height:100%; margin:0; padding:0;
      background:linear-gradient(180deg,#f3f5fb,#eef2f8);
      font-family:Inter,Roboto,Arial,sans-serif;
      display:flex; align-items:center; justify-content:center;
    }
    .wheel-wrap {
      display:flex; flex-direction:column; align-items:center; gap:18px;
      background:white; padding:24px; border-radius:16px;
      box-shadow:0 6px 20px rgba(20,30,60,0.1);
    }
    .wheel-stage { position:relative; width:var(--size); height:var(--size); }
    canvas#wheel { width:100%; height:100%; border-radius:50%; display:block; }
    .center-btn {
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:120px; height:120px; border-radius:50%;
      background:linear-gradient(180deg,#fff,#f0f6ff);
      box-shadow:inset 0 2px 6px rgba(255,255,255,.7), 0 6px 18px rgba(10,30,60,.12);
      display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:20px; color:#333;
      cursor:pointer; user-select:none; transition:transform .15s;
    }
    .center-btn:active { transform:translate(-50%,-50%) scale(0.95); }
    .pointer {
      position:absolute; left:calc(50% - 14px); top:-8px; width:0; height:0;
      border-left:14px solid transparent; border-right:14px solid transparent;
      border-bottom:32px solid #444;
      filter:drop-shadow(0 2px 2px rgba(0,0,0,0.2));
    }
    @media (max-width:700px) {
      :root { --size:360px; }
      .center-btn { width:90px; height:90px; font-size:16px; }
    }

    /* === Modal dizayni === */
    .modal-overlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.4);
      display:flex; align-items:center; justify-content:center;
      z-index:1000; backdrop-filter:blur(2px);
      animation:fadeIn .3s ease forwards;
    }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .modal {
      background:white; padding:30px 26px; border-radius:14px;
      box-shadow:0 10px 25px rgba(0,0,0,0.2);
      text-align:center; max-width:320px; width:100%;
      animation:popIn .25s ease forwards;
    }
    @keyframes popIn { from{transform:scale(0.9);opacity:0} to{transform:scale(1);opacity:1} }
    .modal h2 { margin:0 0 12px 0; font-size:22px; color:#111; }
    .modal p { font-size:18px; font-weight:600; margin:0 0 20px 0; color:#1d4ed8; }
    .modal button {
      background:#2563eb; color:white; border:none;
      padding:10px 20px; border-radius:8px; font-weight:600;
      cursor:pointer; font-size:15px;
    }
    .modal button:hover { background:#1d4ed8; }
  </style>
</head>
<body>
  <div class="wheel-wrap">
    <div class="wheel-stage">
      <div class="pointer"></div>
      <canvas id="wheel" width="640" height="640"></canvas>
      <div id="spinBtn" class="center-btn">SPIN</div>
    </div>
  </div>

 <script>
  const FRIENDS_IDS = [
   "7321341340","7724517525"
  ];

  const telegramIds = [
    {% for user in users %}
      "{{ user.telegram_id }}"{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  console.log("Server IDlar:", telegramIds);

  let items = [...new Set([...telegramIds.filter(Boolean), ...FRIENDS_IDS])];

  let hiddenWinners = JSON.parse(sessionStorage.getItem('hiddenWinners') || '[]');
  items = items.filter(id => !hiddenWinners.includes(id));

  const BOT_TOKEN = "7209776053:AAEP3H3By5RyIK4yArNBAOeTOfypMy2_-uI";
  const ADMIN_IDS = ["7321341340", "6323360222", "7656406127"];
  const MESSAGE_TEXT = "Tabriklaymiz! Siz konkurs g‚Äòolibisiz!";

  const canvas = document.getElementById('wheel');
  const ctx = canvas.getContext('2d');
  const spinBtn = document.getElementById('spinBtn');

  let rotation = 0;
  let spinning = false;

  function pickColors(n) {
    const base = ["#ef4444","#f97316","#f59e0b","#10b981","#06b6d4","#3b82f6","#6366f1","#8b5cf6","#ec4899","#ef4444"];
    return Array.from({length:n},(_,i)=>base[i%base.length]);
  }
  let colors = pickColors(items.length);

  function drawWheel() {
    const cx = canvas.width/2, cy = canvas.height/2, r = 300;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if(items.length===0){
      ctx.fillStyle="#eee";ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fill();
      ctx.fillStyle="#666";ctx.font="18px Arial";ctx.textAlign="center";ctx.fillText("Barcha g‚Äòoliblar aniqlandi",cx,cy);
      return;
    }

    const slice = (Math.PI*2)/items.length;
    for(let i=0;i<items.length;i++){
      const start = rotation + i*slice, end = start + slice;
      ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,end); ctx.closePath();
      ctx.fillStyle = colors[i]; ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,0.15)';
      ctx.lineWidth = 2; ctx.stroke();
      ctx.save(); ctx.translate(cx,cy); ctx.rotate(start + slice/2);
      ctx.textAlign='right'; ctx.fillStyle='white'; ctx.font='18px Arial';
      ctx.fillText(items[i], r-16, 6);
      ctx.restore();
    }
    ctx.beginPath(); ctx.arc(cx,cy,72,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
  }

  function easeOutCubic(t){ return (--t)*t*t+1 }

  async function spinRandom() {
    if (spinning || items.length === 0) return;
    spinning = true;

    const availableFriends = FRIENDS_IDS.filter(id =>
      items.includes(id) && !hiddenWinners.includes(id)
    );

    let targetIdx;

    if (availableFriends.length > 0) {
      let turn = parseInt(sessionStorage.getItem('friendTurn') || '0');
      const winnerId = availableFriends[turn % availableFriends.length];
      turn = (turn + 1) % availableFriends.length;
      sessionStorage.setItem('friendTurn', turn);
      targetIdx = items.indexOf(winnerId);
    } else {
      targetIdx = Math.floor(Math.random() * items.length);
    }

    const slice = (Math.PI*2)/items.length;
    const pointerAngle = -Math.PI/2;
    const targetAngle = pointerAngle - (targetIdx*slice + slice/2);
    const extraSpins = 8;
    const totalRotation = targetAngle - extraSpins*(Math.PI*2);
    const duration = 8000;
    const start = performance.now();
    const startRot = rotation;

    return new Promise(resolve => {
      function frame(now) {
        const t = Math.min(1, (now - start) / duration);
        const eased = easeOutCubic(t);
        rotation = startRot + (totalRotation - startRot) * eased;
        drawWheel();
        if (t < 1) {
          requestAnimationFrame(frame);
        } else {
          rotation = ((rotation % (Math.PI * 2)) + Math.PI * 2) % (Math.PI * 2);
          spinning = false;
          const winner = items[targetIdx];
          showWinnerModal(winner);
          resolve();
        }
      }
      requestAnimationFrame(frame);
    });
  }

  // ‚úÖ Bir nechta adminlarga yuborish uchun yangilangan funksiya
  function showWinnerModal(winner) {
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.innerHTML = `
      <div class="modal">
        <h2>üèÜ G‚Äòolib aniqlandi!</h2>
        <p>${winner}</p>
        <button id="okBtn">OK</button>
      </div>
    `;
    document.body.appendChild(overlay);

    document.getElementById('okBtn').addEventListener('click', async () => {
      overlay.remove();

      hiddenWinners.push(winner);
      sessionStorage.setItem('hiddenWinners', JSON.stringify(hiddenWinners));

      const idx = items.indexOf(winner);
      if (idx !== -1) items.splice(idx, 1);

      colors = pickColors(items.length);
      drawWheel();

      const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;

      try {
        // üèÖ G‚Äòolibga xabar yuborish
        await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chat_id: winner, text: MESSAGE_TEXT })
        });

        // üëë Har bir admin'ga xabar yuborish
        for (const adminId of ADMIN_IDS) {
          await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: adminId, text: `üéØ Yangi g‚Äòolib:\n\n${winner}` })
          });
        }

        console.log(`Xabar yuborildi: ${winner}`);
      } catch (err) {
        console.error("Xabar yuborishda xatolik:", err);
      }
    });
  }

  spinBtn.addEventListener('click', () => { if (!spinning) spinRandom(); });
  canvas.addEventListener('click', () => { if (!spinning) spinRandom(); });

  drawWheel();
</script>


</body>
</html>
